---
title: 支付系统设计
date: {{ date }}
categories:
- 系统设计
---

## 热点账户余额变动

由于Mysql更新数据有行锁的存在，当修改并发很高的时候，数据库很容易出现性能瓶颈

**解决方案**：采用同步插入流水，异步更新余额的方式，也就是说，可以通过定时任务定时轮询流水表中未进行余额计算的记录，将其发生额进行累加后再异步更新到账户的余额表之中。

## 记账死锁问题

A账户和B账户双方转账请求并发，账户系统对每个转账请求都会更新A、B余额，这两个更新需要在一个事务里，正常流程

线程1先更新A，再更新B，线程2先更新B，再更新A

线程1更新完A后会等待B的锁，不提交事务

线程2更新完B后会等待A的锁，不提交事务

这样两个线程互相等待锁，造成死锁。

**解决方案**：更新时根据账户ID进行一个排序，总是保证A先更新。