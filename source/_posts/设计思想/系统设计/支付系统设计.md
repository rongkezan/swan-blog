---
title: 支付系统设计
date: {{ date }}
categories:
- 系统设计
---

## 支付系统架构

数据表：订单表、账户表、流水表、库存表

账户余额可以通过流水推出来，所以流水的总和即为该账户的余额。

定期要通过对账定时任务来判断流水是否可以和余额对应，如果对应不上（例如精度丢失问题），可以通过资金池进行补差。

支付流程：

1. 创建订单（待支付）
2. 支付前预检：冻结相应余额，库存预扣
3. 同步插入流水（幂等）+ 更新订单（已支付）：分布式事务
4. 异步更新账户余额、扣减库存

## 热点账户余额变动

由于Mysql更新数据有行锁的存在，当修改并发很高的时候，数据库很容易出现性能瓶颈

**解决方案**：采用同步插入流水，异步更新余额的方式，也就是说，可以通过定时任务定时轮询流水表中未进行余额计算的记录，将其发生额进行累加后再异步更新到账户的余额表之中。

## 记账死锁问题

A账户和B账户双方转账请求并发，账户系统对每个转账请求都会更新A、B余额，这两个更新需要在一个事务里，正常流程

线程1先更新A，再更新B，线程2先更新B，再更新A

线程1更新完A后会等待B的锁，不提交事务

线程2更新完B后会等待A的锁，不提交事务

这样两个线程互相等待锁，造成死锁。

**解决方案**：更新时根据账户ID进行一个排序，总是保证A先更新。

## 付款问题

现象描述：客户付款时，看到价格是200元，支付成功后发现扣款400元。

原因：付款时，商品价格被商家更改。

解决：付款时需传入金额参数，同时拿传入的参数与后台的数据做比对，如果不一致，则付款失败，要求用户刷新页面获取最新价格。