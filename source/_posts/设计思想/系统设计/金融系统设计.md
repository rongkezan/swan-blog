## 交易

### 行情

把各大交易平台的数据聚合到一起，计算一个综合平均价格透给前端（便于参考）。

### 下单

调用各大交易所的接口，下单实际上是下到实际的交易所，比如binance, bitfinex，会在前端展示这个交易对是属于哪个交易所的，并且有那个交易所的对应的实时价格，用户可以选择一个最佳的价格进行交易。用户可以选择是限价单还是市价单，如果是市价单，直接吃订单薄中的最优价格，如果是限价单，那么就在订单薄中挂一个价格，等待人来吃。

> 限价单会有一个问题，我们平台在交易所下的限价单被吃掉的时候是不会通知我们的，当然我们可以通过查询现有的挂单来看哪些限价单被吃了，但是由于订单量是非常大的，我们无法判断哪个限价单对应哪个用户，所以我们是在平台内部自己维护了一个订单薄，给用户看的是交易平台返回的订单薄，在后台会有定时任务实时地去拉取平台该交易对的最新价格，当挂单的买价格大于最新价格，我们则判断这单撮合成功了。

用户下单时，我们一定要同步下单，以便去对冲风险，如果不这么做的话，可能会产生资损。举个例子，平台有1个BTC，当时价格是1w，用户拿1w买走了这个BTC，之后BTC价格涨到了2w，我们就会浮亏1w。

为什么用户会选择在我们平台交易，因为可以享受到低廉的手续费，因为大平台要享受最低手续费需要每日交易额达到一定数量，而我们平台通过聚合交易恰恰可以达到这个数量，这样就可以通过赚手续费差价的形式来赚取利润。

### 钱包

用户需要在我们平台进行交易就需要先把钱转入我们的平台，我们平台有链上的钱包来存放这些存进来的虚拟资产，这些虚拟资产的都由另一个部门（安全鹭）来管理，如果我们要进行链上转账，我们可以调用他们提供的接口，但我们一般不这么做，因为链上转账有高昂的手续费，只有当有调拨需求的时候，资管部门才会对链上资产进行调拨。

### 调拨

由于我们平台是在每个交易所都有账户，交易的时候可以会产生倾斜，比如binance账户没U了，而bitfinex账户很多U，典型的情况是极端行情下，会有人在我们平台进行搬砖套利。这个时候就要进行资产的调拨，即把binance账户的钱从链上转账到bitfinex，人工操作，但我们系统有一个运营平台，可以监控各大账户的余额，当余额达到预警线的时候会在钉钉中发预警提醒运营。如果余额不够，用户在我们平台下单也会失败。

## 借贷

我们平台是bitfinex（泰达）在中国区的唯一代理商，因此可以拿到一个比较低的利率，我们通过向用户提供借贷服务来赚取利差。

质押率：比如BTC的价格是3w，80%的质押率，能借出2w4U，83%的平仓线，跌到2.49w时爆仓，85%的预警线，跌到2.55w的时候就预警

实现平仓线会略微宽松一点，比如是82%，那么当币价往下扎针的时候有可能不会爆掉，可以尽可能地留住用户。

## 定期固收

发布产品：首先要发布一个产品的模板，每个产品都有相应的模板参数，比如产品的名字，产品的发息周期，每日申购额度，一次最小申购数量等等。

生成产品的定时任务：每个月执行一次，按日为单位，将下个月的产品实例都生成出来，每个产品实例都有开始时间和截止时间，如果当前时间在开始和截止时间之间，那么这么产品就会被展示也可以被申购。

发息定时任务：每日执行一次，根据产品的发息周期，会有每个对应产品的发息日期，用户申购产品之后会根据产品的发息周期和总期限来生成一批回款计划，每次执行定时任务的时候会去找回款计划表，如果有符合的计划则进行回款，前几期只回利息，最后一期回利息和本金。

提前回款：需要将当期以及之后的还款计划都废除，直接归还用户本金。

## 支付系统架构

数据表：订单表、账户表、流水表、库存表

账户余额可以通过流水推出来，所以流水的总和即为该账户的余额。

定期要通过对账定时任务来判断流水是否可以和余额对应，如果对应不上（例如精度丢失问题），可以通过资金池进行补差。

支付流程：

1. 创建订单（待支付）
2. 支付前预检：冻结相应余额，库存预扣
3. 同步插入流水（幂等）+ 更新订单（已支付）：分布式事务
4. 异步更新账户余额、扣减库存

## 热点账户余额变动

由于Mysql更新数据有行锁的存在，当修改并发很高的时候，数据库很容易出现性能瓶颈

**解决方案**：采用同步插入流水，异步更新余额的方式，也就是说，可以通过定时任务定时轮询流水表中未进行余额计算的记录，将其发生额进行累加后再异步更新到账户的余额表之中。

## 记账死锁问题

A账户和B账户双方转账请求并发，账户系统对每个转账请求都会更新A、B余额，这两个更新需要在一个事务里，正常流程

线程1先更新A，再更新B，线程2先更新B，再更新A

线程1更新完A后会等待B的锁，不提交事务

线程2更新完B后会等待A的锁，不提交事务

这样两个线程互相等待锁，造成死锁。

**解决方案**：更新时根据账户ID进行一个排序，总是保证A先更新。

## 付款问题

现象描述：客户付款时，看到价格是200元，支付成功后发现扣款400元。

原因：付款时，商品价格被商家更改。

解决：付款时需传入金额参数，同时拿传入的参数与后台的数据做比对，如果不一致，则付款失败，要求用户刷新页面获取最新价格。