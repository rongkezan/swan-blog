---
title: Redis 单线程模型
date: {{ date }}
categories:
- Redis
---

> NIO异步单线程

## 为什么redis使用单线程模型

1. 使用单线程能带来更好的可维护性、开发和调试
2. 单线程也可以并发地处理客户端的请求
   1. redis使用**I/O多路复用机制**并发处理来自客户端的多个连接，同时等待多个连接发送的请求。
   2. 在I/O多路复用模型中，最重要的函数调用就是select以及类似函数，该方法能同时监控多个文件描述符的可读可写情况，当其中某些文件描述符可读或可写时，select方法就会返回可读以及可写的文件描述符个数。
   3. 使用I/O多路复用机制能够极大地减少系统的开销，系统不再需要额外创建和维护进程和线程来监听来自客户端的大量连接，减少服务器的开发成本和维护成本。
3. **Redis 服务中运行的绝大多数操作性能瓶颈都不是CPU**
   1. 多线程技能能够帮助我们充分利用CPU资源来并发执行不同的任务，但是CPU资源往往都不是Redis的性能瓶颈，哪怕我们在一个普通的Linux服务器上启动Redis服务，它也能在1s内处理一百万个用户请求。
   2. 如果这种吞吐量不能满足我们的要求，更推荐的做法是使用分片的方式将不同的请求交给不同的Redis服务器来处理，而不是在一个Redis服务器中引入大量多线程操作。
   3. Redis不是CPU密集型任务，如果不开启AOF备份，所有Redis的操作都会在内存中完成不会涉及I/O操作，这些数据读写只发生在内存中，所以处理速度是非常快的，整个服务的瓶颈在于网络传输带来的延迟和客户端的数据传输，也就是网络I/O，所以多线程模型处理全部的外部请求可能不是一个好的方案。

## 客户端与redis的通信的一次流程

1. 在redis初始化的时候，redis会将连接应答处理器跟AE_READABLE事件关联起来，接着如果一个客户端与redis发起连接，此时会产生一个AE_READABLE事件，然后由连接应答处理器来处理与客户端的连接，创建客户端对应的socket，同时将这个socket的AE_READABLE事件跟命令请求处理器关联起来。
2. 当客户端想redis发起请求的时候，首先会在socket产生一个AE_READABLE事件，然后由命令请求处理器来处理，这个命令请求处理器就会从socket中读取请求相关数据，然后进行执行和处理。
3. 接着redis这边准备好了给客户端的相应数据之后，就会将socket的AE_WRITEABLE事件跟命令回复处理器关联起来，当客户端这边准备好读取相应数据时，就会在socket上产生一个AE_WRITEABLE事件，会由命令回复处理器来处理，就是准备好写入socket，供客户端来读取。
4. 命令回复处理器写完之后，就会删除这个socket的AE_WRITEABLE事件和命令回复处理器的关联关系。

![在这里插入图片描述](https://img-blog.csdnimg.cn/2020121916394029.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjEwMzAyNg==,size_16,color_FFFFFF,t_70)

